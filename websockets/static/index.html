<!DOCTYPE html>
<html>
<head>
    <title>FastAPI WebSockets - Chat y Notificaciones</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        #chat-container, #notification-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        h1, h2 { color: #0056b3; }
        #messages, #notifications {
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            margin-bottom: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        input[type="text"] {
            width: calc(100% - 100px);
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        .message-item, .notification-item {
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        .message-item:last-child, .notification-item:last-child {
            border-bottom: none;
        }
        .system-notification {
            color: #d9534f; /* Rojo para notificaciones del sistema */
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Chat Simple con FastAPI WebSockets</h1>

    <div id="chat-container">
        <h2>Mensajes del Chat</h2>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Escribe un mensaje..." autocomplete="off"/>
        <button onclick="sendMessage()">Enviar</button>
        <p>Tu ID de cliente (generado al conectar): <span id="clientId">Conectando...</span></p>
    </div>

    <div id="notification-container">
        <h2>Notificaciones en Tiempo Real</h2>
        <div id="notifications"></div>
        <button onclick="sendSystemNotification()">Enviar Notificación del Sistema (solo para ti)</button>
        <button onclick="broadcastNotification()">Broadcast Notificación (a todos)</button>
    </div>

    <script>
        const clientIdSpan = document.getElementById('clientId');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const notificationsDiv = document.getElementById('notifications');

        let clientId = Math.random().toString(36).substring(2, 10); // Generar un ID de cliente simple
        clientIdSpan.textContent = clientId;

        // Establecer la conexión WebSocket
        const ws = new WebSocket(`ws://localhost:8000/ws/${clientId}`);

        ws.onopen = (event) => {
            appendMessage('**Conectado al servidor.**', 'system-notification');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'chat') {
                appendMessage(`**${data.sender}:** ${data.message}`);
            } else if (data.type === 'notification') {
                appendNotification(`[${new Date().toLocaleTimeString()}] ${data.message}`);
            }
        };

        ws.onclose = (event) => {
            appendMessage('**Desconectado del servidor.**', 'system-notification');
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            appendMessage('**Error en la conexión WebSocket.**', 'system-notification');
        };

        function appendMessage(message, className = '') {
            const item = document.createElement('div');
            item.className = 'message-item ' + className;
            item.innerHTML = message;
            messagesDiv.appendChild(item);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll
        }

        function appendNotification(message, className = '') {
            const item = document.createElement('div');
            item.className = 'notification-item ' + className;
            item.innerHTML = message;
            notificationsDiv.appendChild(item);
            notificationsDiv.scrollTop = notificationsDiv.scrollHeight; // Auto-scroll
        }

        // Función para enviar mensajes de chat
        function sendMessage() {
            const message = messageInput.value;
            if (message.trim()) {
                const chatMessage = {
                    type: "chat",
                    sender: clientId,
                    message: message
                };
                ws.send(JSON.stringify(chatMessage));
                messageInput.value = '';
            }
        }

        // Función para enviar una notificación del sistema (solo a este cliente)
        function sendSystemNotification() {
            const notification = {
                type: "notification",
                message: "¡Esta es una notificación personal del sistema para ti!"
            };
            ws.send(JSON.stringify(notification));
        }

        // Función para enviar una notificación de broadcast (a todos los clientes)
        function broadcastNotification() {
            const notification = {
                type: "broadcast_notification",
                message: "¡Alerta general: Nueva actualización disponible!"
            };
            ws.send(JSON.stringify(notification));
        }

        // Permitir enviar mensajes de chat con Enter
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

    </script>
</body>
</html>